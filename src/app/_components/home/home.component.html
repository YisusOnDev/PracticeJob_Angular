<div class="grid-container">
  <h1 class="mat-h1">Panel de control</h1>
  <mat-card class=".dashboard-card">
    <button class="custom-fab-button-container" mat-fab matTooltip="Crear nueva oferta" (click)="addButtonPressed()">
      <mat-icon>add</mat-icon>
    </button>
    <mat-card-header>
      <mat-card-title>
        Últimas ofertas publicadas
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="tableDataSource" multiTemplateDataRows matSort>
        <ng-container matColumnDef="seemore">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element">
            <button mat-icon-button color="primary" (click)="element.isExpanded = !element.isExpanded;">
              <mat-icon *ngIf="!element.isExpanded">expand_more</mat-icon>
              <mat-icon *ngIf="element.isExpanded">expand_less</mat-icon>
            </button>
          </td>
        </ng-container>
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>Id</th>
          <td mat-cell *matCellDef="let element">{{element.id}}</td>
        </ng-container>
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Nombre</th>
          <td mat-cell *matCellDef="let element">{{element.name}}</td>
        </ng-container>
        <ng-container matColumnDef="startDate">
          <th mat-header-cell *matHeaderCellDef>Fecha inicio</th>
          <td mat-cell *matCellDef="let element">{{element.startDate}}</td>
        </ng-container>
        <ng-container matColumnDef="endDate">
          <th mat-header-cell *matHeaderCellDef>Fecha fin</th>
          <td mat-cell *matCellDef="let element">{{element.endDate}}</td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let element">
            <button mat-icon-button color="primary" (click)="editSelectedOffer(element)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="primary" (click)="deleteSelectedPrompt(element.id)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length">
            <div class="row student-element-detail" [@detailExpand]="element.isExpanded ? 'expanded' : 'collapsed'">
              <div *ngIf="element.isExpanded">
                <mat-card class="expanded-card">
                  <mat-tab-group>
                    <mat-tab label="Detalles">
                      <p>
                        Descripción: {{element.description}}
                      </p>
                      <p>
                        Remuneración: {{element.remuneration}}€
                      </p>
                      <p>
                        Horas: {{element.schedule}}
                      </p>
                    </mat-tab>
                    <mat-tab label="Inscripciones">
                      <div id="scroll-container">
                        <div id="flex-scroll">
                          <div *ngIf="element.jobApplications.length > 0">
                            <mat-card *ngFor="let u of element.jobApplications" class="card card-color">
                              <div class="card__title">
                                <img class="card__icon" src="https://i.imgur.com/lqxLNrX.png">
                                <student-fullname class="card__name">{{u.student.name}} {{u.student.lastName}}
                                </student-fullname>
                              </div>
                              <p class="card__details">Edad: {{getAgeFromDate(u.student.birthDate)}} años</p>
                              <p class="card__details">Localización: {{u.student.city}}, {{u.student.province.name}}</p>
                              <p class="card__details">FP: {{u.student.fp.name}}</p>
                              <p class="card__details">Nota media: {{u.student.fpCalification}}</p>
                              <mat-form-field appearance="standard">
                                <mat-label>Modificar inscripción</mat-label>
                                <mat-select (selectionChange)="onJobApplicationModeChange($event.value, u.id, element)"
                                  [(value)]="jobApplicationsModes[u.applicationStatus].value"
                                  style="color: white; text-emphasis-color: white;">
                                  <mat-option *ngFor="let v of jobApplicationsModes" [value]="v.value">
                                    {{v.viewValue}}
                                  </mat-option>
                                </mat-select>
                              </mat-form-field>
                              <br><br>
                              <button mat-fab color="white" aria-label="Contactar con el estudiante"
                                (click)="contactStudentPrompt(u.student)">
                                <mat-icon>email</mat-icon>
                              </button>
                            </mat-card>
                          </div>
                          <div *ngIf="element.jobApplications.length == 0">No hay inscripciones para esta oferta.</div>
                        </div>
                      </div>
                    </mat-tab>
                  </mat-tab-group>
                </mat-card>
              </div>
            </div>

          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="student-detail-row"></tr>
      </table>
      <mat-paginator [pageSizeOptions]="[5, 10, 15, 20]" showFirstLastButtons></mat-paginator>
    </mat-card-content>
  </mat-card>
</div>

<!-- Add New Offer Dialog Form -->
<ng-template #newOfferDialogForm>
  <h2 mat-dialog-title>Nueva Oferta</h2>
  <mat-divider></mat-divider>
  <br>
  <mat-dialog-content class="mat-typography">
    <form class="form" [formGroup]="newOfferForm">
      <mat-form-field class="form-full-width" appearance="fill">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="name" placeholder="Desarrollador Backend .NET Core">
        <mat-error *ngIf="newOfferForm.get('name')?.hasError('required') && newOfferForm.get('name')?.touched">El nombre
          es
          obligatorio
        </mat-error>
        <mat-error *ngIf="newOfferForm.get('name')?.hasError('max') && newOfferForm.get('name')?.touched">El nombre solo
          puede contener 65 carácteres
        </mat-error>
      </mat-form-field>
      <mat-form-field class="form-full-width" appearance="fill">
        <mat-label>Descripción</mat-label>
        <textarea matInput formControlName="description"
          placeholder="Equipo nuevo, desarrollo backend en .NET Core con EF Core 3.1"></textarea>
        <mat-error
          *ngIf="newOfferForm.get('description')?.hasError('required') && newOfferForm.get('description')?.touched">La
          descripción es
          obligatoria
        </mat-error>
      </mat-form-field>
      <mat-form-field class="form-full-width" appearance="fill">
        <mat-label>Remuneración</mat-label>
        <input matInput formControlName="remuneration" type="number" value="0" min="0" placeholder="1200 (Mínimo 0)">
        <mat-error
          *ngIf="newOfferForm.get('remuneration')?.hasError('required') && newOfferForm.get('remuneration')?.touched">La
          remuneración es
          obligatoria y mínimo debe de ser 0
        </mat-error>
      </mat-form-field>
      <mat-form-field class="form-full-width" appearance="fill">
        <mat-label>Horas</mat-label>
        <input matInput formControlName="schedule" placeholder="8 horas">
      </mat-form-field>
      <mat-form-field class="form-full-width" appearance="fill">
        <mat-label>Duración de la oferta</mat-label>
        <mat-date-range-input [rangePicker]="picker" [min]="minDate">
          <input matStartDate placeholder="Fecha inicio" formControlName="startDate">
          <input matEndDate placeholder="Fecha fin" formControlName="endDate">
        </mat-date-range-input>
        <mat-error
          *ngIf="newOfferForm.get('startDate')?.hasError('required') && newOfferForm.get('startDate')?.touched || newOfferForm.get('endDate')?.hasError('required') && newOfferForm.get('endDate')?.touched">
          Las fechas de inicio y fin son obligatorias
        </mat-error>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>
      <mat-form-field class="form-full-width" appearance="fill">
        <mat-label>Ciclos</mat-label>
        <mat-select formControlName="fps" multiple>
          <mat-option *ngFor="let fp of fpList" [value]="fp">{{fp.name}}</mat-option>
        </mat-select>
        <mat-error *ngIf="newOfferForm.get('fps')?.hasError('required') && newOfferForm.get('fps')?.touched">Debes
          seleccionar una FP como mínimo
        </mat-error>
      </mat-form-field>
    </form>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <mat-error *ngIf="newOfferForm.invalid">Por favor, completa el formulario.
    </mat-error>
    <hr>
    <button mat-button matDialogClose="no">Cancelar</button>
    <button (click)="newOfferSubmit()" mat-button>Publicar</button>
  </mat-dialog-actions>
</ng-template>

<!-- Edit Offer Dialog Form -->
<ng-template #editOfferDialogForm>
  <h2 mat-dialog-title>Editar Oferta [{{editOfferForm.get('name')?.value}}]</h2>
  <mat-divider></mat-divider>
  <br>
  <mat-dialog-content class="mat-typography">
    <form class="form" [formGroup]="editOfferForm">
      <mat-form-field class="form-full-width" appearance="fill">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="name" placeholder="Desarrollador Backend .NET Core">
        <mat-error *ngIf="editOfferForm.get('name')?.hasError('required') && editOfferForm.get('name')?.touched">El
          nombre
          es
          obligatorio
        </mat-error>
      </mat-form-field>
      <mat-form-field class="form-full-width" appearance="fill">
        <mat-label>Descripción</mat-label>
        <textarea matInput formControlName="description"
          placeholder="Equipo nuevo, desarrollo backend en .NET Core con EF Core 3.1"></textarea>
        <mat-error
          *ngIf="editOfferForm.get('description')?.hasError('required') && editOfferForm.get('description')?.touched">La
          descripción es
          obligatoria
        </mat-error>
      </mat-form-field>
      <mat-form-field class="form-full-width" appearance="fill">
        <mat-label>Remuneración</mat-label>
        <input matInput formControlName="remuneration" type="number" value="0" min="0" placeholder="1200 (Mínimo 0)">
        <mat-error
          *ngIf="editOfferForm.get('remuneration')?.hasError('required') && editOfferForm.get('remuneration')?.touched">
          La
          remuneración es
          obligatoria y mínimo debe de ser 0
        </mat-error>
      </mat-form-field>
      <mat-form-field class="form-full-width" appearance="fill">
        <mat-label>Horas</mat-label>
        <input matInput formControlName="schedule" placeholder="8 horas">
      </mat-form-field>
      <mat-form-field class="form-full-width" appearance="fill">
        <mat-label>Duración de la oferta</mat-label>
        <mat-date-range-input [rangePicker]="picker" [min]="minDate">
          <input matStartDate placeholder="Fecha inicio" formControlName="startDate">
          <input matEndDate placeholder="Fecha fin" formControlName="endDate">
        </mat-date-range-input>
        <mat-error
          *ngIf="editOfferForm.get('startDate')?.hasError('required') && editOfferForm.get('startDate')?.touched || editOfferForm.get('endDate')?.hasError('required') && editOfferForm.get('endDate')?.touched">
          Las fechas de inicio y fin son obligatorias
        </mat-error>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>
      <mat-form-field class="form-full-width" appearance="fill">
        <mat-label>Ciclos</mat-label>
        <mat-select formControlName="fps" multiple>
          <mat-option *ngFor="let fp of fpList" [value]="fp">{{fp.name}}</mat-option>
        </mat-select>
        <mat-error *ngIf="editOfferForm.get('fps')?.hasError('required') && editOfferForm.get('fps')?.touched">Debes
          seleccionar una FP como mínimo
        </mat-error>
      </mat-form-field>
    </form>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <mat-error *ngIf="editOfferForm.invalid">Por favor, completa el formulario.
    </mat-error>
    <hr>
    <button mat-button matDialogClose="no">Cancelar</button>
    <button (click)="editOfferSubmit()" mat-button>Publicar</button>
  </mat-dialog-actions>
</ng-template>

<ng-template #contactStudentDialogForm>
  <h2 mat-dialog-title>Contactar con el estudiante</h2>
  <mat-divider></mat-divider>
  <br>
  <mat-dialog-content class="mat-typography">
    <form class="form" [formGroup]="contactStudentForm">
      <mat-form-field appearance="fill" class="form-full-width">
        <mat-label>Mensaje</mat-label>
        <textarea matInput formControlName="message"></textarea>
      </mat-form-field>
    </form>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <mat-error *ngIf="contactStudentForm.invalid">Por favor, introduce un mensaje.
    </mat-error>
    <hr>
    <button mat-button matDialogClose="no">Cancelar</button>
    <button (click)="onContactStudent()" mat-button>Enviar</button>
  </mat-dialog-actions>
</ng-template>